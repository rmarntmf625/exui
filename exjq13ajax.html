<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>JS ARRAY EX</title>
    <style>
        td,
        th {
            border: 1px solid black;
        }

        table {
            border-spacing: 0px;
            border-collapse: collapse;
        }
    </style>
</head>

<body>
    <table>
        <caption>상품목록</caption>
        <thead>
            <tr>
                <th>상품번호</th>
                <th>상품명</th>
                <th>가격</th>
                <th>수정</th>
                <th>삭제</th>
            </tr>
        </thead>
        <tbody id="prods">
        </tbody>
        <tfoot>
            <tr>
                <td colspan="5">
                    상품번호:<input type="text" id="pno" />
                    상품명:<input type="text" id="pname" />
                    가격:<input type="text" id="price" />
                    <button id="save">저장</button>
                </td>
            </tr>
        </tfoot>
    </table>
    <script src="jquery-3.4.1.js"></script>
    <script>
        // 상품객체들을 저장하는 배열 생성
        var prodList = [];

        //백그라운드에서 자바스크립트를 사용하여 서버로 요청을 전송
        //요즘방식
        $.ajax({
            url: './products.json',//요청주소
            method: 'GET', //요청방식(GET,POST,PUT,DELETE,.....)
            // data : 'x=y&a=b', //요청시 함께 보낼 데이터(파라미터)
            dataType: 'json' //요청응답으로 받을 데이터 타입(text,html,json,xml,...)

        })
            .done(function (data, status, jqXHR) {
                //요청을 보내고 성공적으로 응답을 받았을때 실행될 함수
                //data: 응답으로 받은 데이터, status: 응답의 상태, jqXHR: 요청객체
                console.log('요청성공 : ', status);
                // dataType을 'json'으로 지정하면, jQuery가 응답을 JSON으로 파싱하여 data인자에 전달(사용시 아래줄 코드 필요없음)
                // data = JSON.parse(data); //JSON 문자열을 자바스크립트 객체로 변환
                console.log(data);
                prodList = data.products;
                refreshProdList();
            })
            .fail(function (jqXHR, status, error) {
                //응답을 받는데 실패했을 때 실행될 함수
                //jqXHR: 요청객체, status: 응답 상태, error: 발생한 오류
                console.log('요청 실패 : ', status);
            })
            .always(function(jqXHR, status){
                 //성공하든 실패하든 요청처리가 끝나면 무조건 실행될 함수
                 console.log('요청처리종료');
             });

        //옛날방식     
        // $.ajax({
        //     url : './products.json',//요청주소
        //     method : 'GET', //요청방식(GET,POST,PUT,DELETE,.....)
        //     // data : 'x=y&a=b', //요청시 함께 보낼 데이터(파라미터)
        //     dataType : 'json', //요청응답으로 받을 데이터 타입(text,html,json,xml,...)
        //     success : function(data, status, jqXHR){
        //         //요청을 보내고 성공적으로 응답을 받았을때 실행될 함수
        //         //data: 응답으로 받은 데이터, status: 응답의 상태, jqXHR: 요청객체
        //         console.log('요청성공 : ', status);
        //         // dataType을 'json'으로 지정하면, jQuery가 응답을 JSON으로 파싱하여 data인자에 전달(사용시 아래줄 코드 필요없음)
        //         // data = JSON.parse(data); //JSON 문자열을 자바스크립트 객체로 변환
        //         console.log(data);
        //         prodList = data.products;
        //         refreshProdList();
        //     },
        //     error : function(jqXHR, status, error){
        //         //응답을 받는데 실패했을 때 실행될 함수
        //         //jqXHR: 요청객체, status: 응답 상태, error: 발생한 오류
        //         console.log('요청 실패 : ',status);
        //     },
        //     complete: function(jqXHR, status){
        //         //성공하든 실패하든 요청처리가 끝나면 무조건 실행될 함수
        //         console.log('요청처리종료');
        //     }
        // });

        //1. 현재 prodList 에 저장되어 있는 상품들의 정보를 상품목록 테이블의 tbody에 출력
        function refreshProdList() {
            $('#prods').empty(); // === .html('');
            for (var i = 0; i < prodList.length; i++) {
                var p = prodList[i];
                var $tr = $('<tr>');
                $('<td>').html(p.no).appendTo($tr);
                $('<td>').html(p.name).appendTo($tr);
                $('<td>').html(p.price).appendTo($tr);
                var $eb = $('<button>').html('수정').addClass('editBtn').attr('data-no', p.no);
                $('<td>').html($eb).appendTo($tr);
                var $db = $('<button>').html('삭제').addClass('delBtn').attr('data-no', p.no);
                $('<td>').html($db).appendTo($tr);
                $tr.appendTo('#prods');
            }
        }

        refreshProdList();
        //2. 저장 버튼을 클릭하면, 입력한 상품 정보를 prodList 에 추가하고,
        //  prodList 에 저장되어 있는 상품들의 정보를 상품목록 테이블의 tbody에 다시 출력
        //  input 엘리먼트에 입력되어 있는 값들은 초기화
        //  (상품번호가 중복된 경우, 에러 메시지를 출력하고 추가 하지 않도록 구현)
        $('#save').on('click', function () {
            var pnoVal = $('#pno').val();
            var pnameVal = $('#pname').val();
            var priceVal = $('#price').val();

            if ($('#pno').prop('disabled')) { //수정
                for (var i = 0; i < prodList.length; i++) {
                    var p = prodList[i];
                    if (pnoVal == p.no) {
                        p.name = pnameVal;
                        p.price = priceVal;
                        break;
                    }
                }
            } else { //추가
                prodList.push({ no: pnoVal, name: pnameVal, price: priceVal });
            }
            refreshProdList();

            $('#pno').val('').prop('disabled', false);
            $('#pname').val('');
            $('#price').val('');
        });

        //3. 상품들마다 옆에 삭제 버튼을 추가하여, 삭제 버튼 클릭시 해당 상품을 prodList에서 제거
        $('#prods').on('click', '.delBtn', function () {
            var no = $(this).attr('data-no');
            for (var i = 0; i < prodList.length; i++) {
                var p = prodList[i];
                if (no == p.no) {
                    prodList.splice(i, 1); //i번 요소부터 1개를 삭제
                    break;
                }
            }
            refreshProdList();
        });

        //4. 상품들마다 옆에 수정 버튼을 추가하여, 수정 버튼 클릭시 해당 상품의 정보를 수정할 수 있도록 구현
        $('#prods').on('click', '.editBtn', function () {
            var no = $(this).attr('data-no');
            for (var i = 0; i < prodList.length; i++) {
                var p = prodList[i];
                if (no == p.no) {
                    $('#pno').val(p.no).prop('disabled', true);
                    $('#pname').val(p.name);
                    $('#price').val(p.price);
                    break;
                }
            }
            refreshProdList();
        });


    </script>
</body>

</html>